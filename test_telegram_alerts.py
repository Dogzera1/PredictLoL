#!/usr/bin/env python3
"""
Teste do Sistema de Alertas Telegram - Bot LoL V3 Ultra Avan√ßado

Script para testar o sistema de alertas do Telegram integrado com tips profissionais.
"""

import os
import sys
import asyncio
import time
from typing import Dict, Any

# Adiciona o diret√≥rio atual ao path para importar m√≥dulos
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from bot.telegram_bot import (
    TelegramAlertsSystem,
    SubscriptionType,
    NotificationType,
    TelegramUser,
    AlertStats
)
from bot.data_models.tip_data import ProfessionalTip
from bot.core_logic.game_analyzer import GameAnalysis, GamePhase, TeamAdvantage
from bot.utils.logger_config import setup_logging, get_logger

# Configura√ß√£o de logging
logger = setup_logging(log_level="INFO", log_file=None)
test_logger = get_logger("test_telegram_alerts")


class MockTelegramBot:
    """Bot mock do Telegram para testes sem API real"""
    
    def __init__(self):
        self.sent_messages = []
        self.bot_info = type('obj', (object,), {
            'username': 'lol_tips_test_bot',
            'first_name': 'LoL Tips Test Bot',
            'id': 123456789
        })
    
    async def get_me(self):
        """Simula bot.get_me()"""
        return self.bot_info
    
    async def send_message(self, chat_id, text, parse_mode=None, disable_web_page_preview=True):
        """Simula envio de mensagem"""
        message = {
            'chat_id': chat_id,
            'text': text,
            'parse_mode': parse_mode,
            'timestamp': time.time()
        }
        self.sent_messages.append(message)
        print(f"üì§ Mensagem enviada para {chat_id}: {text[:100]}...")
        return True


def create_mock_tip(
    team_a: str = "T1",
    team_b: str = "Gen.G",
    league: str = "LCK",
    odds: float = 1.75,
    ev_percentage: float = 12.5,
    confidence: float = 85.0,
    units: float = 3.5
) -> ProfessionalTip:
    """Cria tip mock para testes"""
    
    return ProfessionalTip(
        match_id=f"test_{team_a}_vs_{team_b}",
        team_a=team_a,
        team_b=team_b,
        league=league,
        tournament=f"{league} Summer 2024",
        tip_on_team=team_a,
        odds=odds,
        units=units,
        risk_level="Risco Alto" if units > 3 else "Risco M√©dio",
        confidence_percentage=confidence,
        ev_percentage=ev_percentage,
        analysis_reasoning=f"{team_a} tem vantagem clara com {ev_percentage:.1f}% EV",
        game_time_at_tip="22min",
        game_time_seconds=1320,
        prediction_source="HYBRID",
        data_quality_score=0.89
    )


def create_mock_analysis(
    predicted_winner: str = "T1",
    win_probability: float = 0.756,
    confidence: float = 0.832
) -> GameAnalysis:
    """Cria an√°lise mock para testes"""
    
    team_advantage = TeamAdvantage(
        gold_advantage=3500,
        tower_advantage=2,
        dragon_advantage=1,
        baron_advantage=0,
        kill_advantage=4
    )
    
    return GameAnalysis(
        predicted_winner=predicted_winner,
        win_probability=win_probability,
        confidence_score=confidence,
        current_phase=GamePhase.MID_GAME,
        game_time_seconds=1200,
        team1_advantage=team_advantage,
        analysis_timestamp=time.time()
    )


async def test_system_initialization():
    """Testa inicializa√ß√£o do sistema"""
    print(f"\n{'='*70}")
    print("üîß TESTE: INICIALIZA√á√ÉO DO SISTEMA DE ALERTAS")
    print(f"{'='*70}")
    
    # Token fake para teste
    fake_token = "1234567890:ABCDEF-fake-token-for-testing"
    
    # Inicializa sistema
    alerts_system = TelegramAlertsSystem(fake_token)
    
    # Substitui bot real por mock
    alerts_system.bot = MockTelegramBot()
    
    print("‚úÖ Sistema inicializado:")
    print(f"   ‚Ä¢ Token configurado: {fake_token[:20]}...")
    print(f"   ‚Ä¢ Rate limit: {alerts_system.max_messages_per_hour} msg/hora")
    print(f"   ‚Ä¢ Cache duration: {alerts_system.cache_duration}s")
    print(f"   ‚Ä¢ Usu√°rios registrados: {len(alerts_system.users)}")
    
    return alerts_system


async def test_user_registration(alerts_system: TelegramAlertsSystem):
    """Testa registro de usu√°rios"""
    print(f"\n{'='*70}")
    print("üë• TESTE: REGISTRO DE USU√ÅRIOS")
    print(f"{'='*70}")
    
    # Registra usu√°rios de teste
    test_users = [
        (12345, "joao_apostador", "Jo√£o", SubscriptionType.ALL_TIPS),
        (67890, "maria_trader", "Maria", SubscriptionType.HIGH_VALUE),
        (11111, "carlos_pro", "Carlos", SubscriptionType.HIGH_CONFIDENCE),
        (22222, "ana_premium", "Ana", SubscriptionType.PREMIUM),
    ]
    
    for user_id, username, first_name, sub_type in test_users:
        user = TelegramUser(
            user_id=user_id,
            username=username,
            first_name=first_name,
            subscription_type=sub_type
        )
        alerts_system.users[user_id] = user
        print(f"   ‚úÖ {first_name} ({username}) - {sub_type.value}")
    
    print(f"\nüìä Usu√°rios registrados: {len(alerts_system.users)}")
    
    # Testa estat√≠sticas
    stats = alerts_system.get_system_stats()
    print(f"   ‚Ä¢ Total: {stats['users']['total']}")
    print(f"   ‚Ä¢ Ativos: {stats['users']['active']}")
    print(f"   ‚Ä¢ Por tipo: {stats['users']['subscriptions_by_type']}")
    
    return test_users


async def test_tip_formatting(alerts_system: TelegramAlertsSystem):
    """Testa formata√ß√£o de tips"""
    print(f"\n{'='*70}")
    print("üí¨ TESTE: FORMATA√á√ÉO DE MENSAGENS")
    print(f"{'='*70}")
    
    # Cria tip de teste
    tip = create_mock_tip(
        team_a="T1",
        team_b="Gen.G", 
        league="LCK",
        odds=1.85,
        ev_percentage=18.5,
        confidence=88.0,
        units=4.2
    )
    
    print(f"üéÆ Tip de teste:")
    print(f"   ‚Ä¢ {tip.team_a} vs {tip.team_b}")
    print(f"   ‚Ä¢ Odds: {tip.odds} | EV: +{tip.ev_percentage}%")
    print(f"   ‚Ä¢ Confian√ßa: {tip.confidence_percentage}% | Unidades: {tip.units}")
    
    # Formata mensagem
    formatted_message = alerts_system._format_tip_message(tip)
    
    print(f"\nüìù Mensagem formatada:")
    print(f"```")
    print(formatted_message)
    print(f"```")
    
    return formatted_message


async def test_user_filtering(alerts_system: TelegramAlertsSystem):
    """Testa filtros de usu√°rios para tips"""
    print(f"\n{'='*70}")
    print("üîç TESTE: FILTROS DE USU√ÅRIOS")
    print(f"{'='*70}")
    
    # Tips com diferentes caracter√≠sticas
    test_tips = [
        create_mock_tip("T1", "Gen.G", "LCK", 1.65, 8.0, 75.0, 2.5),    # B√°sica
        create_mock_tip("G2", "FNC", "LEC", 2.10, 15.5, 82.5, 4.0),    # Alto valor
        create_mock_tip("DK", "KT", "LCK", 1.45, 7.2, 92.0, 3.8),      # Alta confian√ßa
        create_mock_tip("SKT", "DRX", "LCK", 1.75, 22.8, 89.5, 5.2),   # Premium
    ]
    
    tip_names = ["B√°sica", "Alto Valor", "Alta Confian√ßa", "Premium"]
    
    for i, tip in enumerate(test_tips):
        print(f"\nüéØ Tip {tip_names[i]}:")
        print(f"   ‚Ä¢ EV: {tip.ev_percentage:.1f}% | Confian√ßa: {tip.confidence_percentage:.1f}%")
        
        eligible_users = alerts_system._get_eligible_users_for_tip(tip)
        print(f"   ‚Ä¢ Usu√°rios eleg√≠veis: {len(eligible_users)}")
        
        # Mostra quais usu√°rios receberiam
        for user_id in eligible_users:
            user = alerts_system.users[user_id]
            print(f"     - {user.first_name} ({user.subscription_type.value})")


async def test_tip_sending(alerts_system: TelegramAlertsSystem):
    """Testa envio de tips"""
    print(f"\n{'='*70}")
    print("üì§ TESTE: ENVIO DE TIPS")
    print(f"{'='*70}")
    
    # Cria tip premium
    premium_tip = create_mock_tip(
        team_a="T1",
        team_b="Gen.G",
        league="LCK",
        odds=1.72,
        ev_percentage=19.8,
        confidence=87.5,
        units=4.8
    )
    
    print(f"üöÄ Enviando tip premium:")
    print(f"   ‚Ä¢ {premium_tip.tip_on_team} @ {premium_tip.odds}")
    print(f"   ‚Ä¢ EV: +{premium_tip.ev_percentage}% | Confian√ßa: {premium_tip.confidence_percentage}%")
    
    # Envia tip
    success = await alerts_system.send_professional_tip(premium_tip)
    
    print(f"\nüìä Resultado:")
    print(f"   ‚Ä¢ Sucesso: {'‚úÖ' if success else '‚ùå'}")
    print(f"   ‚Ä¢ Tips enviadas: {alerts_system.stats.tips_sent}")
    print(f"   ‚Ä¢ Mensagens mock enviadas: {len(alerts_system.bot.sent_messages)}")
    
    # Mostra mensagens enviadas
    if alerts_system.bot.sent_messages:
        print(f"\nüìù √öltimas mensagens enviadas:")
        for msg in alerts_system.bot.sent_messages[-3:]:
            print(f"   ‚Ä¢ Para {msg['chat_id']}: {msg['text'][:80]}...")
    
    return success


async def test_match_updates(alerts_system: TelegramAlertsSystem):
    """Testa envio de atualiza√ß√µes de partida"""
    print(f"\n{'='*70}")
    print("üì∫ TESTE: ATUALIZA√á√ïES DE PARTIDA")
    print(f"{'='*70}")
    
    # Cria an√°lise mock
    analysis = create_mock_analysis(
        predicted_winner="T1",
        win_probability=0.78,
        confidence=0.85
    )
    
    print(f"üìä An√°lise de teste:")
    print(f"   ‚Ä¢ Vencedor prov√°vel: {analysis.predicted_winner}")
    print(f"   ‚Ä¢ Probabilidade: {analysis.win_probability:.1%}")
    print(f"   ‚Ä¢ Confian√ßa: {analysis.confidence_score:.1%}")
    
    # Envia atualiza√ß√£o
    await alerts_system.send_match_update(analysis, "test_match_123")
    
    print(f"\n‚úÖ Atualiza√ß√£o enviada:")
    print(f"   ‚Ä¢ Match updates enviadas: {alerts_system.stats.match_updates_sent}")


async def test_rate_limiting(alerts_system: TelegramAlertsSystem):
    """Testa sistema de rate limiting"""
    print(f"\n{'='*70}")
    print("‚ö° TESTE: RATE LIMITING")
    print(f"{'='*70}")
    
    test_user_id = 12345  # Jo√£o
    
    print(f"üìä Testando rate limiting para usu√°rio {test_user_id}:")
    print(f"   ‚Ä¢ Limite: {alerts_system.max_messages_per_hour} msg/hora")
    
    # Testa verifica√ß√£o inicial
    can_send_initial = alerts_system._can_send_to_user(test_user_id)
    print(f"   ‚Ä¢ Pode enviar inicialmente: {'‚úÖ' if can_send_initial else '‚ùå'}")
    
    # Simula envio de v√°rias mensagens
    for i in range(alerts_system.max_messages_per_hour):
        alerts_system.user_message_times.setdefault(test_user_id, []).append(time.time())
    
    can_send_after_limit = alerts_system._can_send_to_user(test_user_id)
    print(f"   ‚Ä¢ Pode enviar ap√≥s {alerts_system.max_messages_per_hour} msgs: {'‚úÖ' if can_send_after_limit else '‚ùå'}")
    
    # Simula passagem de tempo (mensagens antigas)
    alerts_system.user_message_times[test_user_id] = [time.time() - 3700]  # 1h atr√°s
    can_send_after_cleanup = alerts_system._can_send_to_user(test_user_id)
    print(f"   ‚Ä¢ Pode enviar ap√≥s limpeza: {'‚úÖ' if can_send_after_cleanup else '‚ùå'}")


async def test_cache_system(alerts_system: TelegramAlertsSystem):
    """Testa sistema de cache"""
    print(f"\n{'='*70}")
    print("üíæ TESTE: SISTEMA DE CACHE")
    print(f"{'='*70}")
    
    # Cria tip para teste de cache
    tip = create_mock_tip("DK", "T1", "LCK", 2.15, 11.2, 76.8, 3.2)
    
    print(f"üîÑ Testando cache de tips:")
    print(f"   ‚Ä¢ Cache atual: {len(alerts_system.recent_tips_cache)} items")
    
    # Primeira tentativa de envio (deve funcionar)
    success1 = await alerts_system.send_professional_tip(tip)
    print(f"   ‚Ä¢ Primeira tentativa: {'‚úÖ' if success1 else '‚ùå'}")
    print(f"   ‚Ä¢ Cache ap√≥s 1¬™: {len(alerts_system.recent_tips_cache)} items")
    
    # Segunda tentativa imediata (deve ser bloqueada pelo cache)
    success2 = await alerts_system.send_professional_tip(tip)
    print(f"   ‚Ä¢ Segunda tentativa (imediata): {'‚úÖ' if success2 else '‚ùå'}")
    
    # Simula expira√ß√£o do cache
    tip_cache_key = f"{tip.match_id}_{tip.tip_on_team}_{tip.odds}"
    if tip_cache_key in alerts_system.recent_tips_cache:
        alerts_system.recent_tips_cache[tip_cache_key] = time.time() - 400  # 6min atr√°s
    
    # Terceira tentativa ap√≥s "expira√ß√£o"
    success3 = await alerts_system.send_professional_tip(tip)
    print(f"   ‚Ä¢ Terceira tentativa (ap√≥s expira√ß√£o): {'‚úÖ' if success3 else '‚ùå'}")
    
    # Testa limpeza do cache
    alerts_system.cleanup_old_cache()
    print(f"   ‚Ä¢ Cache ap√≥s limpeza: {len(alerts_system.recent_tips_cache)} items")


async def test_system_stats(alerts_system: TelegramAlertsSystem):
    """Testa estat√≠sticas do sistema"""
    print(f"\n{'='*70}")
    print("üìä TESTE: ESTAT√çSTICAS DO SISTEMA")
    print(f"{'='*70}")
    
    # Obt√©m estat√≠sticas completas
    stats = alerts_system.get_system_stats()
    
    print(f"üë• Usu√°rios:")
    print(f"   ‚Ä¢ Total: {stats['users']['total']}")
    print(f"   ‚Ä¢ Ativos: {stats['users']['active']}")
    print(f"   ‚Ä¢ Bloqueados: {stats['users']['blocked']}")
    
    print(f"\nüì® Alertas:")
    print(f"   ‚Ä¢ Total enviado: {stats['alerts']['total_sent']}")
    print(f"   ‚Ä¢ Tips enviadas: {stats['alerts']['tips_sent']}")
    print(f"   ‚Ä¢ Atualiza√ß√µes: {stats['alerts']['match_updates_sent']}")
    print(f"   ‚Ä¢ Taxa de sucesso: {stats['alerts']['success_rate']:.1f}%")
    print(f"   ‚Ä¢ Falhas: {stats['alerts']['failed_deliveries']}")
    
    print(f"\n‚ö° Rate Limiting:")
    print(f"   ‚Ä¢ M√°x por hora: {stats['rate_limiting']['max_messages_per_hour']}")
    print(f"   ‚Ä¢ Cache duration: {stats['rate_limiting']['cache_duration_minutes']}min")
    print(f"   ‚Ä¢ Tips em cache: {stats['rate_limiting']['recent_tips_cached']}")
    
    print(f"\nüîî Subscri√ß√µes por tipo:")
    for sub_type, count in stats['users']['subscriptions_by_type'].items():
        print(f"   ‚Ä¢ {sub_type}: {count}")


async def test_system_alerts(alerts_system: TelegramAlertsSystem):
    """Testa alertas do sistema"""
    print(f"\n{'='*70}")
    print("üö® TESTE: ALERTAS DO SISTEMA")
    print(f"{'='*70}")
    
    # Testa diferentes tipos de alerta
    alert_tests = [
        ("Sistema iniciado com sucesso", "success"),
        ("Nova vers√£o dispon√≠vel", "info"),
        ("Rate limit atingido", "warning"),
        ("Erro na API do PandaScore", "error")
    ]
    
    for message, alert_type in alert_tests:
        print(f"üì¢ Enviando alerta '{alert_type}': {message}")
        await alerts_system.send_system_alert(message, alert_type)
    
    print(f"\n‚úÖ Alertas do sistema enviados: {alerts_system.stats.system_alerts_sent}")


async def demonstrate_full_workflow(alerts_system: TelegramAlertsSystem):
    """Demonstra workflow completo"""
    print(f"\n{'='*70}")
    print("üöÄ DEMONSTRA√á√ÉO: WORKFLOW COMPLETO")
    print(f"{'='*70}")
    
    # Cen√°rio: Tips chegando ao longo do tempo
    scenario_tips = [
        create_mock_tip("T1", "Gen.G", "LCK", 1.65, 12.8, 82.5, 3.8),
        create_mock_tip("G2", "FNC", "LEC", 2.35, 25.2, 78.0, 5.1),
        create_mock_tip("DK", "KT", "LCK", 1.52, 8.5, 94.2, 2.9),
    ]
    
    print(f"üéÆ Simulando chegada de 3 tips:")
    
    for i, tip in enumerate(scenario_tips, 1):
        print(f"\nüì• Tip {i}/{len(scenario_tips)}:")
        print(f"   ‚Ä¢ {tip.team_a} vs {tip.team_b} @ {tip.odds}")
        print(f"   ‚Ä¢ EV: +{tip.ev_percentage}% | Conf: {tip.confidence_percentage}%")
        
        # Envia tip
        success = await alerts_system.send_professional_tip(tip)
        print(f"   ‚Ä¢ Resultado: {'‚úÖ Enviada' if success else '‚ùå Rejeitada'}")
        
        # Pequena pausa para simular tempo real
        await asyncio.sleep(0.1)
    
    # Resultado final
    print(f"\nüìà Resultado Final:")
    print(f"   ‚Ä¢ Tips processadas: {len(scenario_tips)}")
    print(f"   ‚Ä¢ Tips enviadas: {alerts_system.stats.tips_sent}")
    print(f"   ‚Ä¢ Mensagens enviadas: {len(alerts_system.bot.sent_messages)}")
    print(f"   ‚Ä¢ Taxa de sucesso: {alerts_system.stats.success_rate:.1f}%")
    
    # Mostra algumas mensagens enviadas
    if alerts_system.bot.sent_messages:
        print(f"\nüìù √öltimas 3 mensagens enviadas:")
        for msg in alerts_system.bot.sent_messages[-3:]:
            print(f"   ‚Ä¢ Chat {msg['chat_id']}: {msg['text'][:60]}...")


async def main():
    """Fun√ß√£o principal de teste"""
    print("üöÄ Iniciando testes do Sistema de Alertas Telegram...")
    print(f"üîß Python: {sys.version}")
    print(f"üìÅ Diret√≥rio: {os.getcwd()}")
    
    try:
        # Inicializa√ß√£o
        alerts_system = await test_system_initialization()
        
        # Executa testes sequenciais
        test_functions = [
            lambda: test_user_registration(alerts_system),
            lambda: test_tip_formatting(alerts_system),
            lambda: test_user_filtering(alerts_system),
            lambda: test_tip_sending(alerts_system),
            lambda: test_match_updates(alerts_system),
            lambda: test_rate_limiting(alerts_system),
            lambda: test_cache_system(alerts_system),
            lambda: test_system_stats(alerts_system),
            lambda: test_system_alerts(alerts_system),
            lambda: demonstrate_full_workflow(alerts_system)
        ]
        
        for test_func in test_functions:
            try:
                await test_func()
            except Exception as e:
                print(f"\n‚ùå Erro no teste: {e}")
        
        # Estat√≠sticas finais
        print(f"\n{'='*70}")
        print("üìà ESTAT√çSTICAS FINAIS")
        print(f"{'='*70}")
        
        final_stats = alerts_system.get_system_stats()
        
        print(f"üë• Usu√°rios registrados: {final_stats['users']['total']}")
        print(f"üì§ Total de alertas enviados: {final_stats['alerts']['total_sent']}")
        print(f"üéØ Tips enviadas: {final_stats['alerts']['tips_sent']}")
        print(f"üì∫ Atualiza√ß√µes enviadas: {final_stats['alerts']['match_updates_sent']}")
        print(f"üö® Alertas de sistema: {final_stats['alerts']['system_alerts_sent']}")
        print(f"üìà Taxa de sucesso: {final_stats['alerts']['success_rate']:.1f}%")
        print(f"üì¶ Mensagens mock enviadas: {len(alerts_system.bot.sent_messages)}")
        
        print(f"\nüéâ TODOS OS TESTES DO TELEGRAM CONCLU√çDOS COM SUCESSO!")
        
    except Exception as e:
        print(f"\n‚ùå Erro fatal durante os testes: {e}")
        sys.exit(1)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nüõë Teste interrompido pelo usu√°rio")
    except Exception as e:
        print(f"\n\n‚ùå Erro fatal: {e}")
        sys.exit(1) 